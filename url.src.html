<!doctype html>
<html lang=en-US>
<meta charset=utf-8>
<title>URL Standard</title>
<link rel=stylesheet href=//www.whatwg.org/style/specification>
<link rel=icon href=//resources.whatwg.org/logo-url.svg>

<div class=head>

<p><a class=logo href=//www.whatwg.org/><img alt=WHATWG src=//resources.whatwg.org/logo-url.svg width=100 height=100></a></p>
<h1>URL</h1>
<h2 class="no-num no-toc">Living Standard &mdash; Last Updated [DATE: 01 Jan 1901]</h2>

<dl>
 <dt>This Version:
 <dd><a href=//url.spec.whatwg.org/>http://url.spec.whatwg.org/</a>

 <dt>Participate:</dt>
 <dd>Send feedback to
  <a href="http://www.whatwg.org/mailing-list">whatwg@whatwg.org</a>
  (<a href="http://www.whatwg.org/mailing-list#specs">archives</a>) or
  <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WHATWG&amp;component=URL">file a bug</a>
  (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WHATWG&amp;component=URL&amp;resolution=---">open bugs</a>)
 <dd><a href="http://wiki.whatwg.org/wiki/IRC">IRC: #whatwg on Freenode</a>

 <dt>Version History:
 <dd><a href=https://github.com/whatwg/url/commits>https://github.com/whatwg/url/commits</a>
 <dd><a href="https://twitter.com/urlstandard">@urlstandard</a>

 <dt>Editor:
 <dd class="h-card vcard"><a class="u-url url p-name fn" lang="nl" href="http://annevankesteren.nl/">Anne van Kesteren</a>
  &lt;<a class="u-email email" href="mailto:annevk@annevk.nl">annevk@annevk.nl</a>>
</dl>

<script src=//resources.whatwg.org/file-bug.js async></script>

<p class=copyright><a rel="license" href="http://creativecommons.org/publicdomain/zero/1.0/"><img src="http://i.creativecommons.org/p/zero/1.0/80x15.png" alt="CC0"></a>
To the extent possible under law, the editors have waived all copyright and
related or neighboring rights to this work. In addition, as of
[DATE: 01 Jan 1901], the editors have made this specification available
under the
<a rel="license"
href="http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0">Open Web Foundation Agreement Version 1.0</a>,
which is available at
http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0.

</div>



<h2 class="no-num no-toc">Table of Contents</h2>
<!--toc-->



<h2 class=no-num>Goals</h2>

<p>The URL standard sets out to make URLs fully predictable and
interoperable. This is the plan:

<ul>
 <li><p>Align RFC 3986 and RFC 3987 with contemporary implementations and
 obsolete them in the process. (E.g. spaces, other "illegal" code points,
 query encoding, equality, canonicalization, are all concepts not entirely
 shared, or defined.) URL parsing needs to become as solid as HTML parsing.
 <span data-anolis-ref class=informative>RFC3986</span>
 <span data-anolis-ref class=informative>RFC3987</span>

 <li><p>Standardize on the term URL. URI and IRI are just confusing. In
 practice a single algorithm is used for both so keeping them distinct is
 not helping anyone. URL also easily wins the
 <a href="http://www.googlefight.com/index.php?word1=url&amp;word2=uri">search result popularity contest</a>.

 <li><p>Define URL's existing JavaScript API in full detail and add
 enhancements to make it easier to work with. Add a new <code>URL</code>
 object as well for URL manipulation without usage of HTML elements. (Useful
 for Web Workers.)
</ul>

<p class=note>As the editor learns more about the subject matter the goals
might increase in scope somewhat.



<h2>Conformance</h2>
<p>All diagrams, examples, and notes in this specification are
non-normative, as are all sections explicitly marked non-normative.
Everything else in this specification is normative.

<p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in the normative parts of this specification are to be
interpreted as described in RFC2119. For readability, these words do
not appear in all uppercase letters in this specification.
<span data-anolis-ref>RFC2119</span>



<h2>Terminology</h2>

<p>Some terms used in this specification are defined in the
Encoding Standard. <span data-anolis-ref>ENCODING</span>

<p>The <dfn>EOF code point</dfn> signifies the end of a string or
code point stream.

<p>The <dfn>ASCII digits</dfn> are code points in the range U+0030 to U+0039.

<p>The <dfn>ASCII hex digits</dfn> are <span>ASCII digits</span> or are
code points in the range U+0041 to U+0046 or in the range U+0061 to U+0066.

<p>The <dfn>ASCII alpha</dfn> are code points in the range U+0041 to U+005A
or in the range U+0061 to U+007A.

<p>The <dfn>ASCII alphanumeric</dfn> are <span>ASCII digits</span> or
<span>ASCII alpha</span>.


<p>The <dfn>domain label separators</dfn> are the code points
U+002E, U+3002, U+FF0E, and U+FF61.
<!-- IDNA2003/UTS #46; IDNA2008 does not define these -->



<h2>Percent-encoded bytes</h2>

<p>A <dfn>percent-encoded byte</dfn> is "<code title>%</code>", followed by
two <span>ASCII hex digits</span>. Sequences of
<span title="percent-encoded byte">percent-encoded bytes</span>, after
conversion to bytes, should not cause
<span data-anolis-spec=encoding>utf-8 decode</span> to emit any
<span data-anolis-spec=encoding title="decoder error">decoder errors</span>.

<p>To <dfn>percent encode</dfn> a <var title>byte</var> into a
<span>percent-encoded byte</span>, return a string consisting of
"<code title>%</code>", followed by a double-digit, uppercase, hexadecimal
representation of <var title>byte</var>.

<!-- the escape sets are minimal as escaping can lead to problems; we might
     be able to escape more here but only if implementors are willing and
     there's an upside -->
<p>The <dfn>simple encode set</dfn> are all code points less than
U+0020 (i.e. excluding U+0020) and all code points greater than U+007E.

<p>The <dfn>query encode set</dfn> is the
<span>simple encode set</span> and code points U+0020,
'<code title>"</code>', <!-- 0x22 -->
"<code title>#</code>", <!-- 0x23 -->
"<code title>&lt;</code>", <!-- 0x3C -->
"<code title>></code>", <!-- 0x3E -->
and
"<code title>`</code>". <!-- 0x60 -->

<p>The <dfn>default encode set</dfn> is the
<span>query encode set</span> and code point
"<code title>?</code>". <!-- 0x3F -->

<p>The <dfn>password encode set</dfn> is the
<span>default encode set</span> and code points
"<code title>/</code>", <!-- 0x2F -->
"<code title>@</code>", <!-- 0x40 -->
and
"<code title>\</code>". <!-- 0x5C -->

<p>The <dfn>username encode set</dfn> is the
<span>password encode set</span> and code point
"<code title>:</code>". <!-- 0x3A -->

<p>To <dfn>potentially percent encode</dfn> a <var title>code point</var>,
using an <var title>encode set</var>, and an optional
<var title>encoding override</var>, run these steps:

<ol>
 <li><p>Let <var title>encoding</var> be <var title>encoding override</var>,
 if given, and <span data-anolis-spec=encoding>utf-8</span> otherwise.

 <li><p>If <var title>code point</var> is not in
 <var title>encode set</var>, return <var title>code point</var>.

 <li>
  <p>Let <var title>bytes</var> be the result of running
  <span data-anolis-spec=encoding>encode</span> on
  <var title>code point</var> using <var title>encoding</var> as
  <span data-anolis-spec=encoding>encoding</span>.

  <p>Whenever the <span data-anolis-spec=encoding>encoder</span> algorithm
  emits an <span data-anolis-spec=encoding>encoder error</span>, emit a
  0x3F byte instead and do not terminate the algorithm.

  <p class=note>Using <span data-anolis-spec=encoding>utf-8</span> ensures
  you never hit an <span data-anolis-spec=encoding>encoder error</span>
  here, but unfortunately legacy content uses other
  <span data-anolis-spec=encoding title=encoding>encodings</span>.

 <li><p><span>Percent encode</span> each byte in <var title>bytes</var>, and
 then return them concatenated, in the same order.
</ol>

<p>To <dfn>percent decode</dfn> a string <var title>input</var>, run these
steps:

<ol>
 <li><p>Let <var title>pointer</var> be a pointer into
 <var title>input</var>, initially zero (pointing to the first code point),
 and let <var title>c</var> be the code point it points to.

 <li><p>Let <var title>remaining</var> be the substring after
 <var title>pointer</var> in <var title>input</var>.

 <li><p>Let <var title>output</var> be an empty string.

 <li>
  <p>While <var title>c</var> is not the <span>EOF code point</span>, run
  these substeps:

  <ol>
   <li>While <var title>c</var> is not "<code title>%</code>" or the
   <span>EOF code point</span>, append <var title>c</var> to
   <var title>output</var> and increase <var title>pointer</var> by one.

   <li>If <var title>c</var> is "<code title>%</code>" and
   <var title>remaining</var> does not start with two
   <span>ASCII hex digits</span>, append <var title>c</var> to
   <var title>output</var> increase <var title>pointer</var> by one, and run
   these substeps again.

   <li>
    <p>Let <var title>bytes</var> be an empty sequence of bytes.

    <p>While <var title>c</var> is "<code title>%</code>" and
    <var title>remaining</var> starts with two <span>ASCII hex digits</span>,
    append to <var title>bytes</var> a byte whose value is
    <var title>remaining</var>'s two leading code points, interpreted as
    hexadecimal number, and increase <var title>pointer</var> by three.

    <p>Append to <var title>output</var> the result of running the
    <span data-anolis-spec=encoding>utf-8 decoder</span> on
    <var title>bytes</var>.

    <p class=note><span data-anolis-spec=encoding>utf-8 decode</span> is not
    used here as it would consume the byte order mark which is not desired.
  </ol>

 <li><p>Return <var title>output</var>.
</ol>



<h2>Hosts and IP addresses</h2>

<!-- Punycode:
     http://tools.ietf.org/html/rfc3492
     http://mothereff.in/punycode -->

<p>A <dfn title=concept-host>host</dfn> is a string that represents a
network address, either in the form of a
<span title=concept-domain>domain</span> or an
<span title=concept-ipv6>IPv6 address</span>.

<p class=note>This is a slightly more generic definition of
<span title=concept-host>host</span> than its traditional meaning for the
sake of convenience.
<!-- "convenience's sake" as The Economist would write it is ugly -->

<p>A <dfn title=concept-domain>domain</dfn> is an ordered list of one or
more <dfn title=concept-domain-label>domain labels</dfn>.

<p>An <dfn title=concept-ipv6>IPv6 address</dfn> is a 128-bit identifier and
for the purposes of this specification represented as an ordered list of
eight <dfn title=concept-ipv6-piece>16-bit pieces</dfn>.
<span data-anolis-ref class=informative>IPV6</span>


<h3 id=host-writing>Writing</h3>

<p>A <span title=concept-host>host</span> must be either a
<span title=concept-domain>domain</span> or "<code title>[</code>", followed
by an <span title=concept-ipv6>IPv6 address</span>, followed by
"<code title>]</code>".

<p>A <span title=concept-domain>domain</span> is one or more
<span title=concept-domain-label>domain labels</span> separated from each
other by a
<span title="domain label separators">domain label separator</span>,
optionally followed by a
<span title="domain label separators">domain label separator</span>.

<p class=note>A trailing
<span title="domain label separators">domain label separator</span>
signifies an empty <span title=concept-domain-label>domain label</span>.
<!-- if a domain has 4 labels, no trailing dot, and each label consists only
     of ASCII digits it's IPv4 because the last label of a domain cannot
     start with an ASCII digit -->

<p class=XXX>A <span title=concept-domain-label>domain label</span> is ...

<p>An <span title=concept-ipv6>IPv6 address</span> is defined in the
<a href="http://tools.ietf.org/html/rfc4291#section-2.2">"Text Representation of Addresses" chapter of IP Version 6 Addressing Architecture</a>.
<span data-anolis-ref>IPV6</span>
<!-- http://tools.ietf.org/html/rfc5952 updates that RFC, but it seems as
     far as what developers can do we should be liberal

     XXX should we define the format inline instead just like STD 66? -->


<h3 id=host-parsing>Parsing</h3>

<p>The <dfn title=concept-host-parser>host parser</dfn> takes a string
<var title>input</var> and then runs these steps:

<ol>
 <li>
  <p>If <var title>input</var> starts with "<code title>[</code>", run these
  substeps:

  <ol>
   <li><p>If <var title>input</var> does not end with
   "<code title>]</code>", return failure.

   <li><p>Return the result of
   <span title=concept-ipv6-parser>parsing</span> <var title>input</var>
   with its leading "<code title>[</code>" and trailing
   "<code title>]</code>" removed.
  </ol>

 <li><p>Let <var title>host</var> be the result of running
 <span>percent decode</span> on <var title>input</var>.

 <li><p class=XXX><a href="http://wiki.whatwg.org/wiki/URL#IDNA">IDNA hell</a>
</ol>

<p>The <dfn title=concept-ipv6-parser>IPv6 parser</dfn> takes a string
<var title>input</var> and then runs these steps:

<ol>
 <li><p>Let <var title>address</var> be a new
 <span title=concept-ipv6>IPv6 address</span> with its
 <span title=concept-ipv6-piece>16-bit pieces</span> initialized to 0.

 <li><p>Let <var title>piece pointer</var> be a pointer into
 <var title>address</var>'s
 <span title=concept-ipv6-piece>16-bit pieces</span>, initially zero
 (pointing to the first <span title=concept-ipv6-piece>16-bit piece</span>),
 and let <var title>piece</var> be the
 <span title=concept-ipv6-piece>16-bit piece</span> it points to.

 <li><p>Let <var title>compress pointer</var> be another pointer into
 <var title>pieces</var>, initially null and pointing to nothing.

 <li><p>Let <var title>pointer</var> be a pointer into
 <var title>input</var>, initially zero (pointing to the first code point),
 and let <var title>c</var> be the code point it points to.

 <li><p>Let <var title>remaining</var> be the substring after
 <var title>pointer</var> in <var title>input</var>.

 <li>
  <p>If <var title>c</var> is "<code title>:</code>", run these substeps:

  <ol>
   <li><p>If <var title>remaining</var> does not start with
   "<code title>:</code>", return failure.

   <li><p>Increase <var title>pointer</var> by two.

   <li><p>Increase <var title>piece pointer</var> by one and then set
   <var title>compress pointer</var> to <var title>piece pointer</var>.
  </ol>

 <li>
  <p><i title id=concept-ipv6-parser-main>Main</i>:
  While <var title>c</var> is not the <span>EOF code point</span>, run these
  substeps:

  <ol>
   <li><p>If <var title>piece pointer</var> is eight, return failure.

   <li>
    <p>If <var title>c</var> is "<code title>:</code>", run these inner
    substeps:

    <ol>
     <li>If <var title>compress pointer</var> is not null, return failure.

     <li>Increase <var title>piece pointer</var> by one, set
     <var title>compress pointer</var> to <var title>piece pointer</var>,
     and then jump to <a href=#concept-ipv6-parser-main>Main</a>.
    </ol>

   <li><p>Let <var title>value</var> and <var title>length</var> be 0.

   <li><p>While <var title>length</var> is less than 4 and
   <var title>c</var> is an
   <span title="ASCII hex digits">ASCII hex digit</span>, set
   <var title>value</var> to
   <var title>value</var> &times; 0x10 + <var title>c</var> interpreted as hexadecimal number,
   and increase <var title>pointer</var> and <var title>length</var> by one.

   <li>
    <p>Based on <var title>c</var>:

    <dl class=switch>
     <dt>"<code title>.</code>"
     <dd>
      <p>If <var title>length</var> is 0, return failure.
      <p>Decrease <var title>pointer</var> by <var title>length</var>.
      <p>Jump to <a href=#concept-ipv6-parser-ipv4>IPv4</a>.

     <dt>"<code title>:</code>"
     <dd>
      <p>Increase <var title>pointer</var> by one.
      <p>If <var title>c</var> is the <span>EOF code point</span>, return
      failure.

     <dt>Anything but the <span>EOF code point</span>
     <dd><p>Return failure.
    </dl>

   <li><p>Set <var title>piece</var> to <var title>value</var>.

   <li><p>Increase <var title>piece pointer</var> by one.
  </ol>

 <li><p>If <var title>c</var> is the <span>EOF code point</span>, jump to
 <a href=#concept-ipv6-parser-finale>Finale</a>.

 <li><p><i title id=concept-ipv6-parser-ipv4>IPv4</i>:
 If <var title>piece pointer</var> is greater than six, return failure.

 <li><p>Let <var title>dots seen</var> be 0.

 <li>
  <p>While <var title>c</var> is not the <span>EOF code point</span>, run
  these substeps:

  <ol>
   <li><p>Let <var title>value</var> be 0.

   <li><p>While <var title>c</var> is an
   <span title="ASCII digits">ASCII digit</span>, set <var title>value</var> to
   <var title>value</var> &times; 10 + <var title>c</var> interpreted as decimal number
   and increase <var title>pointer</var> by one.

   <li><p>If <var title>value</var> is greater than 255, return failure.

   <li><p>If <var title>dots seen</var> is less than 3 and
   <var title>c</var> is not a "<code title>.</code>", return failure.

   <li><p>If <var title>dots seen</var> is 3 and <var title>c</var> is not
   the <span>EOF code point</span>, return failure.

   <li><p>Set <var title>piece</var> to
   <var title>piece</var> &times; 0x10 + <var title>value</var>.

   <li><p>If <var title>dots seen</var> is 0 or 2, increase
   <var title>piece pointer</var> by one.

   <li><p>Increase <var title>dots seen</var> by one.
  </ol>

 <li>
  <p><i title id=concept-ipv6-parser-finale>Finale</i>:
  If <var title>compress pointer</var> is not null, run these substeps:

  <ol>
   <li><p>Let <var title>swaps</var> be
   <var title>piece pointer</var> &minus; <var title>compress pointer</var>.

   <li><p>Set <var title>piece pointer</var> to seven.

   <li><p>While neither <var title>piece pointer</var> nor
   <var title>swaps</var> is zero, replace <var title>piece</var> with the
   <span title=concept-ipv6-piece>piece</span> at pointer
   <var title>compress pointer</var> + <var title>swaps</var> and then
   decrease <var title>piece pointer</var> and <var title>swaps</var> by
   one.
  </ol>

 <li><p>Otherwise, if <var title>compress pointer</var> is null and
 <var title>piece pointer</var> is not eight, return failure.

 <li><p>Return <var title>address</var>.
</ol>


<h3 id=host-serializing>Serializing</h3>

<p>The <dfn title=concept-host-serializer>host serializer</dfn> takes a
<span title=concept-host>host</span> <var title>host</var> and then runs
these steps:

<ol>
 <li><p>If <var title>host</var> is null, return the empty string.
 <!-- XXX Are we okay with this? -->

 <li><p>If <var title>host</var> is an
 <span title=concept-ipv6>IPv6 address</span>, return
 "<code title>[</code>", followed by the result of running the
 <span title=concept-ipv6-serializer>IPv6 serializer</span> on <var title>host</var>,
 followed by "<code title>]</code>".

 <li class=XXX><p>If <var title>host</var> is a
 <span title=concept-domain>domain</span> ...
</ol>

<p>The <dfn title=concept-ipv6-serializer>IPv6 serializer</dfn> takes an
<span title=concept-ipv6>IPv6 address</span> <var title>address</var> and
then runs these steps:

<ol>
 <li><p>Let <var title>output</var> be the empty string.

 <li>
  <p>Let <var title>compress pointer</var> be a pointer to the first
  <span title=concept-ipv6-piece>16-bit piece</span> in the first longest
  sequences of <var title>address</var>'s
  <span title=concept-ipv6-piece>16-bit pieces</span> that are 0.

  <p class=example>In <code title>0:f:0:0:f:f:0:0</code> it would point to
  the second 0.

 <li><p>If there is no sequence of <var title>address</var>'s
 <span title=concept-ipv6-piece>16-bit pieces</span> that are 0 longer than
 one, set <var title>compress pointer</var> to null.

 <li>
  <p>For each <var title>piece</var> in <var title>address</var>'s
  <span title=concept-ipv6-piece>pieces</span>, run these substeps:

  <ol>
   <li><p>If <var title>compress pointer</var> points to
   <var title>piece</var>, append "<code title>::</code>" to
   <var title>output</var> and then run these substeps again with all
   subsequent <span title=concept-ipv6-piece>pieces</span> in
   <var title>address</var>'s <span title=concept-ipv6-piece>pieces</span>
   that are 0 skipped or go the next step in the overall set of steps if
   that leaves no <span title=concept-ipv6-piece>pieces</span>.

   <li><p>Append <var title>piece</var>, represented as the shortest
   possible lowercase hexadecimal number, to <var title>output</var>.

   <li><p>If <var title>piece</var> is not the last of
   <var title>address</var>'s <span title=concept-ipv6-piece>pieces</span>,
   append "<code title>:</code>" to <var title>output</var>.
  </ol>

 <li><p>Return <var title>output</var>.
</ol>

<p class=note>This algorithm requires the recommendation from
A Recommendation for IPv6 Address Text Representation.
<span data-anolis-ref class=informative>IPV6TEXT</span>

<!-- Safari/Gecko/Opera do not normalize IPv6. Chrome does. This algorithm
     follows Chrome because we normalize domains too. -->



<h2>URLs</h2>

<!-- History behind URL as term:
     http://lists.w3.org/Archives/Public/uri/2012Oct/0080.html -->

<p>A <dfn title=concept-url>URL</dfn> is a string that represents an
identifier.

<p>A <span title=concept-url>URL</span> is either a
<span title=concept-relative-url>relative URL</span> or an
<span title=concept-absolute-url>absolute URL</span>. Either form can be
followed by a <span title=concept-url-fragment>fragment</span>.

<p>A <dfn title=concept-relative-url>relative URL</dfn> is a
<span title=concept-url>URL</span> that is relative to a
<span title=concept-parsed-url>parsed URL</span>. Such a
<span title=concept-parsed-url>parsed URL</span> is a
<dfn title=concept-base-url>base URL</dfn>. If the
<span title=concept-base-url>base URL</span> has no
<span>relative scheme</span>, <span title=concept-url-parser>parsing</span>
the <span title=concept-relative-url>relative URL</span> results in failure.

<p>An <dfn title=concept-absolute-url>absolute URL</dfn> stands on its own
and is therefore a potential <span title=concept-base-url>base URL</span>.

<p><span title=concept-url-parser>Parsing</span> (provided it does not
return failure) and <span title=concept-url-serializer>serializing</span> a
<span title=concept-url>URL</span> will turn it into an
<span title=concept-absolute-url>absolute URL</span>. The intermediate form
is named a <dfn title=concept-parsed-url>parsed URL</dfn>. The components a
<span title=concept-url>URL</span> can consist of and
<span title=concept-parsed-url>parsed URL</span> consists of are
<dfn title=concept-url-scheme>scheme</dfn>,
<dfn title=concept-url-scheme-data>scheme data</dfn> (not used if
<span title=concept-url-scheme>scheme</span> is a <span>relative scheme</span>),
<dfn title=concept-url-username>username</dfn>,
<dfn title=concept-url-password>password</dfn>,
<dfn title=concept-url-host>host</dfn>,
<dfn title=concept-url-port>port</dfn>,
<dfn title=concept-url-path>path</dfn>,
<dfn title=concept-url-query>query</dfn>, and
<dfn title=concept-url-fragment>fragment</dfn>.

<p>A <dfn>relative scheme</dfn> is a
<span title=concept-url-scheme>scheme</span> listed in the first column of
the following table. A <dfn>default port</dfn> is a
<span>relative scheme</span>'s optional corresponding
<span title=concept-url-port>port</span> and is listed in the second column
on the same row.

<table>
 <tr><th><span title=concept-url-scheme>scheme</span>
     <th><span title=concept-url-port>port</span>
 <tr><td>"<code title>ftp</code>"<td>"<code title>21</code>"
 <tr><td>"<code title>file</code>"<td>
 <tr><td>"<code title>gopher</code>"<td>"<code title>70</code>"
 <tr><td>"<code title>http</code>"<td>"<code title>80</code>"
 <tr><td>"<code title>https</code>"<td>"<code title>443</code>"
 <tr><td>"<code title>ws</code>"<td>"<code title>80</code>"
 <tr><td>"<code title>wss</code>"<td>"<code title>443</code>"
</table>


<h3>Writing</h3>

<!-- http://tantek.com/2011/238/b1/many-ways-slice-url-name-pieces -->

<p>A <span title=concept-url>URL</span> must be either a
<span title=concept-relative-url>relative URL</span> or an
<span title=concept-absolute-url>absolute URL</span>, optionally followed by
"<code title>#</code>" and a
<span title=concept-url-fragment>fragment</span>.

<p>An <span title=concept-absolute-url>absolute URL</span> is a
<span title=concept-url-scheme>scheme</span>, followed by
"<code title>:</code>", followed by
<span title=concept-url-scheme-data>scheme data</span>.

<p>A <span title=concept-url-scheme>scheme</span> is one
<span>ASCII alpha</span>, followed by zero or more of
<span>ASCII alphanumeric</span>, "<code title>+</code>",
"<code title>-</code>", and "<code title>.</code>". A
<span title=concept-url-scheme>scheme</span> must be registered
<span class=XXX>...</span>.

<p>The syntax of <span title=concept-url-scheme-data>scheme data</span>
depends on the <span title=concept-url-scheme>scheme</span> and is typically
defined alongside it. For a <span>relative scheme</span>,
<span title=concept-url-scheme-data>scheme data</span> is a
<span title=concept-scheme-relative-url>scheme-relative URL</span>. For
other <span title=concept-url-scheme>schemes</span>, specifications or
standards must define <span title=concept-url-scheme-data>scheme data</span>
either literally as or as a subset of one or more <span>URL units</span>
that do not start with "<code title>?</code>".

<p>A <span title=concept-relative-url>relative URL</span> is either a
<span title=concept-scheme-relative-url>scheme-relative URL</span>, an
<span title=concept-absolute-path-relative-url>absolute-path-relative URL</span>,
or a <span title=concept-path-relative-url>path-relative URL</span> that
does not start with a <span title=concept-url-scheme>scheme</span> and
"<code title>:</code>". A
<span title=concept-relative-url>relative URL</span> must be relative to a
<span title=concept-base-url>base URL</span> with a
<span>relative scheme</span>.

<p>A <dfn title=concept-scheme-relative-url>scheme-relative URL</dfn> is
"<code title>//</code>", optionally followed by
<span title=concept-url-userinfo>userinfo</span> and "<code title>@</code>",
followed by a <span title=concept-host>host</span>, optionally followed
by "<code title>:</code>" and a <span title=concept-url-port>port</span>,
optionally followed by either an
<span title=concept-absolute-path-relative-url>absolute-path-relative URL</span>
or a "<code title>?</code>" and a <span title=concept-url-query>query</span>.

<p><dfn title=concept-url-userinfo>Userinfo</dfn> is a
<span title=concept-url-username>username</span>, optionally followed by a
"<code title>:</code>" and a
<span title=concept-url-password>password</span>.

<p>A <span title=concept-url-username>username</span> is zero or more
<span>URL units</span>, excluding "<code title>/</code>",
"<code title>:</code>, "<code title>?</code>", and "<code title>@</code>".
<!-- password without ":" (sorted on ASCII position) -->

<p>A <span title=concept-url-password>password</span> is zero or more
<span>URL units</span>, excluding "<code title>/</code>",
"<code title>?</code>", and "<code title>@</code>".

<p>A <span title=concept-url-port>port</span> is zero or more
<span>ASCII digits</span>.

<p>An
<dfn title=concept-absolute-path-relative-url>absolute-path-relative URL</dfn>
is "<code title>/</code>", followed by a
<span title=concept-path-relative-url>path-relative URL</span> that does not
start with "<code title>/</code>".

<p>A <dfn title=concept-path-relative-url>path-relative URL</dfn> is zero or
more <span title="path segment">path segments</span> separated from each
other by a "<code title>/</code>", optionally followed by a
"<code title>?</code>" and a <span title=concept-url-query>query</span>.

<p>A <dfn>path segment</dfn> is zero or more <span>URL units</span>,
excluding "<code title>/</code>" and "<code title>?</code>".

<p>A <span title=concept-url-query>query</span> is zero or more
<span>URL units</span>.

<p>A <span title=concept-url-fragment>fragment</span> is zero or more
<span>URL units</span>.

<p>The <dfn>URL units</dfn> are <span>ASCII alphanumeric</span>,
"<code title>!</code>",<!-- 0x21, sub-delims -->
"<code title>$</code>",<!-- 0x24, sub-delims -->
"<code title>&</code>",<!-- 0x26, sub-delims -->
"<code title>'</code>",<!-- 0x27, sub-delims -->
"<code title>(</code>",<!-- 0x28, sub-delims -->
"<code title>)</code>",<!-- 0x29, sub-delims -->
"<code title>*</code>",<!-- 0x2A, sub-delims -->
"<code title>+</code>",<!-- 0x2B, sub-delims -->
"<code title>,</code>",<!-- 0x2C, sub-delims -->
"<code title>-</code>",<!-- 0x2D, iunreserved -->
"<code title>.</code>",<!-- 0x2E, iunreserved -->
"<code title>/</code>",<!-- 0x2F, iquery/ifragment -->
"<code title>:</code>",<!-- 0x3A, ipchar -->
"<code title>;</code>",<!-- 0x3B, sub-delims -->
"<code title>=</code>",<!-- 0x3D, sub-delims -->
"<code title>?</code>",<!-- 0x3F, iquery/ifragment -->
"<code title>@</code>",<!-- 0x40, ipchar -->
"<code title>_</code>",<!-- 0x5F, iunreserved -->
"<code title>~</code>",<!-- 0x7E, iunreserved -->
code points in the ranges
U+00A0 to U+D7FF,
U+E000 to <!--U+F8FF,
U+F900 to -->U+FDCF,
U+FDF0 to U+FFEF,
U+10000 to U+1FFFD,
U+20000 to U+2FFFD,
U+30000 to U+3FFFD,
U+40000 to U+4FFFD,
U+50000 to U+5FFFD,
U+60000 to U+6FFFD,
U+70000 to U+7FFFD,
U+80000 to U+8FFFD,
U+90000 to U+9FFFD,
U+A0000 to U+AFFFD,
U+B0000 to U+BFFFD,
U+C0000 to U+CFFFD,
U+D0000 to U+DFFFD,
U+E1000 to U+EFFFD,
U+F0000 to U+FFFFD,
U+100000 to U+10FFFD,
and <span title="percent-encoded byte">percent-encoded bytes</span>.
<!-- XXX there is a mismatch with
     http://www.whatwg.org/specs/web-apps/current-work/#preprocessing-the-input-stream
     I think they should match, need advice -->

<p class=note>Code points higher than U+009F will be converted to
<span title="percent-encoded byte">percent-encoded bytes</span> by the
<span title=concept-url-parser>URL parser</span>.



<h3>Parsing</h3>

<p>Aside from the components mentioned earlier, a
<span title=concept-parsed-url>parsed URL</span> also has an associated
<dfn>relative flag</dfn>.

<p>To <dfn>clear</dfn> a <span title=concept-parsed-url>parsed URL</span>,
set its <span title=concept-url-scheme>scheme</span>,
<span title=concept-url-scheme-data>scheme data</span>,
<span title=concept-url-username>username</span>, and
<span title=concept-url-port>port</span> to the empty string,
<span title=concept-url-password>password</span>,
<span title=concept-url-host>host</span>,
<span title=concept-url-query>query</span>, and
<span title=concept-url-fragment>fragment</span> to null, and
its <span title=concept-url-path>path</span> to the empty list.

<p class=XXX>Add the ability to halt on the first conformance error.

<p>The <dfn title=concept-url-parser>URL parser</dfn> takes a string
<var title>input</var>, optionally with a
<span title=concept-base-url>base URL</span> <var title>base</var>,
optionally with an <span data-anolis-spec=encoding>encoding</span>
<var title>encoding override</var>, optionally with an
<span title=concept-parsed-url>parsed URL</span> <var title>url</var>, and
if <var title>url</var> is given, optionally with a state override
<var title>state override</var>, and then runs these steps:

<p class=note>The <var title>url</var> and <var title>state override</var>
arguments can be used for API manipulation of a
<span title=concept-parsed-url>parsed URL</span>.

<ol>
 <li>
  <p>If <var title>url</var> is not given:

  <ol>
   <li><p>Set <var title>url</var> to a new
   <span title=concept-parsed-url>parsed URL</span>.

   <li><p><span>Clear</span> <var title>url</var>.

   <li><p>Remove any leading and trailing
   <span data-anolis-spec=encoding>ASCII whitespace</span> from
   <var title>input</var>.
  </ol>

 <li><p>Let <var title>state</var> be <var title>state override</var>
 if given, or <b title>scheme start state</b> otherwise.

 <li><p>If <var title>base</var> is not given, set it to null.

 <li><p>If <var title>encoding override</var> is not given, set it to
 <span data-anolis-spec=encoding>utf-8</span>.

 <li><p>Let <var title>buffer</var> be the empty string.

 <li><p>Let the <var title>@ flag</var> and the <var title>[] flag</var> be
 unset.

 <li><p>Let <var title>pointer</var> be a pointer to first code point in
 <var title>input</var>.

 <li>
  <p>Keep running the following state machine by switching on
  <var title>state</var>, increasing <var title>pointer</var> by one after
  each time it is run, as long as <var title>pointer</var> does not point
  past the end of <var title>input</var>.

  <p>Let <var title>c</var> be the code point to which
  <var title>pointer</var> points.

  <p>Let <var title>remaining</var> be the substring starting after
  <var title>pointer</var> in <var title>input</var>.

  <p class=example>If <var title>input</var> is
  "<code title>mailto:example@example</code>" and <var title>pointer</var>
  points to "<code title>@</code>", <var title>remaining</var> is
  "<code title>example</code>".

  <dl class=switch>
   <dt><b title>scheme start state</b>
   <dd>
    <ol>
     <li><p>If <var title>c</var> is an <span>ASCII alpha</span>,
     append <var title>c</var>, lowercased, to <var title>buffer</var>, and
     set <var title>state</var> to <b title>scheme state</b>.

     <li><p>Otherwise, if <var title>state override</var> is not given, set
     <var title>buffer</var> to the empty string, set <var title>state</var>
     to <b title>no scheme state</b>, and decrease <var title>pointer</var>
     by one.

     <li><p>Otherwise, terminate this algorithm.
    </ol>

   <dt><b title>scheme state</b>
   <dd>
    <ol>
     <li><p>If <var title>c</var> is an <span>ASCII alphanumeric</span>,
     "<code title>+</code>", "<code title>-</code>", or
     "<code title>.</code>", append <var title>c</var>, lowercased, to
     <var title>buffer</var>.

     <li>
      <p>Otherwise, if <var title>c</var> is "<code title>:</code>", set
      <var title>url</var>'s <span title=concept-url-scheme>scheme</span> to
      <var title>buffer</var>, <var title>buffer</var> to the empty string,
      and then run these substeps:

      <ol>
       <li><p>If <var title>state override</var> is given,
       terminate this algorithm.

       <li><p>If <var title>url</var>'s
       <span title=concept-url-scheme>scheme</span> is
       a <span>relative scheme</span>, set <var title>url</var>'s
       <span>relative flag</span>.

       <li><p>If <var title>url</var>'s
       <span title=concept-url-scheme>scheme</span> is
       "<code title>file</code>", set <var title>state</var> to
       <b title>relative state</b>.
       <!-- not combined with the subsequent step for clarity -->

       <li><p>Otherwise, if <var title>url</var>'s
       <span>relative flag</span> is set, <var title>base</var> is not null
       and <var title>base</var>'s
       <span title=concept-url-scheme>scheme</span> is equal to
       <var title>url</var>'s <span title=concept-url-scheme>scheme</span>,
       set <var title>state</var> to <b title>relative state</b>.

       <li><p>Otherwise, if <var title>url</var>'s
       <span>relative flag</span> is set, set <var title>state</var> to
       <b title>authority start state</b>.

       <li><p>Otherwise, set <var title>state</var> to
       <b title>scheme data state</b>.
      </ol>

     <li><p>Otherwise, set <var title>state</var> to <b title>no scheme state</b>,
     <var title>buffer</var> to the empty string, and start over (from the
     first code point in <var title>input</var>).
    </ol>

   <dt><b title>scheme data state</b>
   <dd>
    <ol>
     <li><p>If <var title>state override</var> is not given and <var title>c</var>
     is "<code title>#</code>", set <var title>url</var>'s
     <span title=concept-url-fragment>fragment</span> to
     the empty string and <var title>state</var> to
     <b title>fragment state</b>.

     <li><p>Otherwise, if <var title>c</var> is none of
     <span>EOF code point</span>, U+0009, U+000A, and U+000D,
     <span>potentially percent encode</span> <var title>c</var> using the
     <span>simple encode set</span>, and append the result to
     <var title>url</var>'s
     <span title=concept-url-scheme-data>scheme data</span>.
    </ol>

   <dt><b title>no scheme state</b>
   <dd>
    <p>If <var title>base</var> is null, or <var title>base</var>'s
    <span title=concept-url-scheme>scheme</span> is not a
    <span>relative scheme</span>, return failure.

    <p class=note>You do not want to check <var title>base</var>'s
    <span>relative flag</span> here, as the
    <span title=concept-url-scheme>scheme</span> itself can have been
    changed to something non-sensical through the
    <code title=dom-URL-protocol>protocol</code> attribute.
    <!-- XXX maybe disallow setting protocol to non-sensical values -->

    <p>Otherwise, set <var title>state</var> to <b title>relative state</b>,
    and decrease <var title>pointer</var> by one.

   <dt><b title>relative state</b>
   <dd>
    <p>Set <var title>url</var>'s <span>relative flag</span>, set
    <var title>url</var>'s <span title=concept-url-scheme>scheme</span> to
    <var title>base</var>'s <span title=concept-url-scheme>scheme</span>,
    and then, based on <var title>c</var>:

    <dl class=switch>
     <dt><span>EOF code point</span>
     <dd>
      <p>Set <var title>url</var>'s <span title=concept-url-host>host</span>
      to <var title>base</var>'s <span title=concept-url-host>host</span>,
      <var title>url</var>'s <span title=concept-url-port>port</span> to
      <var title>base</var>'s <span title=concept-url-port>port</span>,
      <var title>url</var>'s <span title=concept-url-path>path</span> to
      <var title>base</var>'s <span title=concept-url-path>path</span>,
      <var title>url</var>'s <span title=concept-url-query>query</span> to
      <var title>base</var>'s <span title=concept-url-query>query</span>,
      and then terminate this algorithm.

     <dt>"<code title>/</code>"
     <dt>"<code title>\</code>"
     <dd>
      <p>If <var title>remaining</var> starts with either
      "<code title>/</code>" or "<code title>\</code>", increase
      <var title>pointer</var> by one, and run these steps:

      <ol>
       <li><p>If <var title>url</var>'s <span title=concept-url-scheme>scheme</span> is
       "<code title>file</code>", set <var title>state</var> to
       <b title>file host state</b>.

       <li><p>Otherwise set <var title>state</var> to
       <b title>authority start state</b>.
      </ol>

      <p>Otherwise, set
      <var title>url</var>'s <span title=concept-url-host>host</span> to
      <var title>base</var>'s <span title=concept-url-host>host</span>,
      <var title>url</var>'s <span title=concept-url-port>port</span> to
      <var title>base</var>'s <span title=concept-url-port>port</span>,
      <var title>state</var> to <b title>relative path start state</b>,
      and decrease <var title>pointer</var> by one.

     <dt>"<code title>?</code>"
     <dd><p>Set
     <var title>url</var>'s <span title=concept-url-host>host</span> to
     <var title>base</var>'s <span title=concept-url-host>host</span>,
     <var title>url</var>'s <span title=concept-url-port>port</span> to
     <var title>base</var>'s <span title=concept-url-port>port</span>,
     <var title>url</var>'s <span title=concept-url-path>path</span> to
     <var title>base</var>'s <span title=concept-url-path>path</span>,
     <var title>url</var>'s <span title=concept-url-query>query</span> to the empty string,
     and <var title>state</var> to <b title>query state</b>.

     <dt>"<code title>#</code>"
     <dd><p>Set
     <var title>url</var>'s <span title=concept-url-host>host</span> to
     <var title>base</var>'s <span title=concept-url-host>host</span>,
     <var title>url</var>'s <span title=concept-url-port>port</span> to
     <var title>base</var>'s <span title=concept-url-port>port</span>,
     <var title>url</var>'s <span title=concept-url-path>path</span> to
     <var title>base</var>'s <span title=concept-url-path>path</span>,
     <var title>url</var>'s <span title=concept-url-query>query</span> to
     <var title>base</var>'s <span title=concept-url-query>query</span>,
     <var title>url</var>'s <span title=concept-url-fragment>fragment</span> to the empty string,
     and <var title>state</var> to <b title>fragment state</b>.

     <dt>Otherwise
     <dd><p>Set
     <var title>url</var>'s <span title=concept-url-host>host</span> to
     <var title>base</var>'s <span title=concept-url-host>host</span>,
     <var title>url</var>'s <span title=concept-url-port>port</span> to
     <var title>base</var>'s <span title=concept-url-port>port</span>,
     <var title>url</var>'s <span title=concept-url-path>path</span> to
     <var title>base</var>'s <span title=concept-url-path>path</span>, then
     remove <var title>url</var>'s <span title=concept-url-path>path</span>'s last string, set
     <var title>state</var> to <b title>relative path start state</b>,
     and decrease <var title>pointer</var> by one.
    </dl>

   <dt><b title>authority start state</b>
   <dd><p>If <var title>c</var> is neither "<code title>/</code>" nor
   "<code title>\</code>", set <var title>state</var> to
   <b title>authority state</b>, and decrease <var title>pointer</var> by one.

   <dt><b title>authority state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title>c</var> is "<code title>@</code>", run these substeps:

      <ol>
       <li><p>If the <var title>@ flag</var> is set, prepend
       "<code title>%40</code>" to <var title>buffer</var>.

       <li><p>Set the <var title>@ flag</var>.

       <li>
        <p>For each <var title>code point</var> in <var title>buffer</var>, run these substeps:

        <ol>
         <li><p>If <var title>code point</var> is "<code title>:</code>" and
         <var title>url</var>'s
         <span title=concept-url-password>password</span> is null, set
         <var title>url</var>'s <span title=concept-url-password>password</span>
         to the empty string and continue.

         <li><p><span>potentially percent encode</span> <var title>code point</var> using
         the <span>default encode set</span> and append the result to
         <var title>url</var>'s <span title=concept-url-password>password</span>
         if <var title>url</var>'s <span title=concept-url-password>password</span>
         is non-null, and to
         <var title>url</var>'s <span title=concept-url-username>username</span>
         otherwise.
        </ol>
       <li><p>Set <var title>buffer</var> to the empty string.
      </ol>

     <li><p>If <var title>c</var> is one of <span>EOF code point</span>,
     "<code title>/</code>", "<code title>\</code>", "<code title>?</code>",
     and "<code title>#</code>", decrease <var title>pointer</var> by the
     number of code points in <var title>buffer</var>, set
     <var title>buffer</var> to the empty string, and
     <var title>state</var> to <b title>host state</b>.

     <li><p>Otherwise, if <var title>c</var> is none of U+0009, U+000A, and
     U+000D, append <var title>c</var> to <var title>buffer</var>.
    </ol>

   <dt><b title>file host state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title>c</var> is one of <span>EOF code point</span>,
      "<code title>/</code>", "<code title>\</code>", "<code title>?</code>",
      and "<code title>#</code>", decrease <var title>pointer</var> by one,
      and run these substeps:

      <ol>
       <li>
        <p>If <var title>buffer</var> consists of two code points, of
        which the first is an <span>ASCII alpha</span> and the second is
        either "<code title>:</code>" or "<code title>|</code>", set state
        to <b title>relative path state</b>.

        <p class=note>This is a quirk for parsing Windows drive letters and
        therefore <var title>buffer</var> is not reset here.

       <li>
        <p>Otherwise, run these steps:

        <ol>
         <li><p>Let <var title>host</var> be the result of
         <span title=concept-host-parser>host parsing</span>
         <var title>buffer</var>.

         <li><p>If <var title>host</var> is failure, return failure.

         <li><p>Set
         <var title>url</var>'s <span title=concept-url-host>host</span> to
         <var title>host</var>, <var title>buffer</var> to the empty string,
         and <var title>state</var> to <b title>relative path start state</b>.
        </ol>
      </ol>

     <li><p>Otherwise, if <var title>c</var> is none of U+0009, U+000A, and
     U+000D, append <var title>c</var> to <var title>buffer</var>.
    </ol>

   <dt><b title>host state</b>
   <dt><b title>hostname state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title>c</var> is "<code title>:</code>" and the
      <var title>[] flag</var> is unset, run these substeps:

      <ol>
       <li><p>Let <var title>host</var> be the result of
       <span title=concept-host-parser>host parsing</span>
       <var title>buffer</var>.

       <li><p>If <var title>host</var> is failure, return failure.

       <li><p>Set <var title>url</var>'s <span title=concept-url-host>host</span> to
       <var title>host</var>, <var title>buffer</var> to the empty string,
       and <var title>state</var> to <b title>port state</b>.

       <li><p>If <var title>state override</var> is <b title>hostname state</b>,
       terminate this algorithm.
      </ol>

     <li>
      <p>Otherwise, if <var title>c</var> is one of
      <span>EOF code point</span>, "<code title>/</code>",
      "<code title>\</code>", "<code title>?</code>", and
      "<code title>#</code>", decrease <var title>pointer</var> by one, and
      run these substeps:

      <ol>
       <li><p>Let <var title>host</var> be the result of
       <span title=concept-host-parser>host parsing</span>
       <var title>buffer</var>.

       <li><p>If <var title>host</var> is failure, return failure.

       <li><p>Set <var title>url</var>'s <span title=concept-url-host>host</span> to
       <var title>host</var>, <var title>buffer</var> to the empty string,
       and <var title>state</var> to <b title>relative path start state</b>.

       <li><p>If <var title>state override</var> is given, terminate this
       algorithm.
      </ol>

     <li>
      <p>Otherwise, if <var title>c</var> is none of U+0009, U+000A, and
      U+000D, run these substeps:

      <ol>
       <li><p>If <var title>c</var> is "<code title>[</code>", set the
       <var title>[] flag</var>.

       <li><p>If <var title>c</var> is "<code title>]</code>", unset the
       <var title>[] flag</var>.

       <li><p>Append <var title>c</var> to <var title>buffer</var>.
      </ol>
    </ol>

   <dt><b title>port state</b>
   <dd>
    <ol>
     <li><p>If <var title>c</var> is an <span title="ASCII digits">ASCII digit</span>,
     append <var title>c</var> to <var title>buffer</var>.

     <li>
      <p>Otherwise, if <var title>c</var> is one of
      <span>EOF code point</span>, "<code title>/</code>",
      "<code title>\</code>", "<code title>?</code>", and
      "<code title>#</code>", or <var title>state override</var> is given, run
      these substeps:
      <ol>
       <li><p>Remove any leading U+0030 code points from
       <var title>buffer</var>.

       <li><p>If <var title>buffer</var> is equal to
       <var title>url</var>'s <span title=concept-url-scheme>scheme</span>'s
       <span>default port</span>, set <var title>buffer</var> to the empty
       string.

       <li><p>Set <var title>url</var>'s
       <span title=concept-url-port>port</span> to <var title>buffer</var>.

       <li><p>If <var title>state override</var> is given, terminate this
       algorithm.

       <li><p>Set <var title>buffer</var> to the empty string,
       <var title>state</var> to <b title>relative path start state</b>, and
       decrease <var title>pointer</var> by one.
      </ol>

     <li><p>Otherwise, return failure.
    </ol>

   <dt><b title>relative path start state</b>
   <dd><p>Set <var title>state</var> to <b title>relative path state</b> and
   if <var title>c</var> is neither "<code title>/</code>" nor
   "<code title>\</code>", decrease <var title>pointer</var> by one.

   <dt><b title>relative path state</b>
   <dd>
    <ol>
     <li>
      <p>If either <var title>c</var> is one of
      <span>EOF code point</span>, "<code title>/</code>", and
      "<code title>\</code>", or <var title>state override</var> is not given and
      <var title>c</var> is one of "<code title>?</code>" and
      "<code title>#</code>", run these substeps:
      <ol>
       <li><p>If <var title>buffer</var> is "<code title>..</code>" and
       <var title>c</var> is one of <span>EOF code point</span>,
       "<code title>/</code>", and "<code title>\</code>", set the last
       string in <var title>url</var>'s <span title=concept-url-path>path</span> to the empty
       string.

       <li><p>Otherwise, if <var title>buffer</var> is
       "<code title>..</code>", remove the last string from
       <var title>url</var>'s <span title=concept-url-path>path</span>.

       <li><p>Otherwise, if <var title>buffer</var> is
       "<code title>.</code>" and <var title>c</var> is one of
       <span>EOF code point</span>, "<code title>/</code>", and
       "<code title>\</code>", append an empty string to
       <var title>url</var>'s <span title=concept-url-path>path</span>.

       <li>
        <p>Otherwise, if <var title>buffer</var> is not
        "<code title>.</code>", run these inner substeps:

        <ol>
         <li>
          <p>If <var title>url</var>'s <span title=concept-url-scheme>scheme</span> is
          "<code title>file</code>", <var title>url</var>'s <span title=concept-url-path>path</span>
          is the empty list, <var title>buffer</var> consists of two
          code points, of which the first is an <span>ASCII alpha</span>,
          and the second is either "<code title>:</code>" or
          "<code title>|</code>", replace the second code point in
          <var title>buffer</var> with "<code title>:</code>".

          <p class=note>Windows drive letters are beautiful, no?

         <li><p>Append <var title>buffer</var> to
         <var title>url</var>'s <span title=concept-url-path>path</span>.
        </ol>

       <li><p>Set <var title>buffer</var> to the empty string.

       <li><p>If <var title>c</var> is "<code title>?</code>", set
       <var title>url</var>'s <span title=concept-url-query>query</span> to the empty string,
       and <var title>state</var> to <b title>query state</b>.

       <li><p>If <var title>c</var> is "<code title>#</code>", set
       <var title>url</var>'s <span title=concept-url-fragment>fragment</span> to the empty string,
       and <var title>state</var> to <b title>fragment state</b>.
      </ol>

     <li><p>Otherwise, if <var title>c</var> is "<code title>%</code>" and
     <var title>remaining</var> starts with either "<code title>2E</code>"
     or "<code title>2e</code>", increase <var title>pointer</var> by two,
     and append "<code title>.</code>" to <var title>buffer</var>.
     <!-- Chrome unescapes more here; Safari does nothing -->

     <li><p>Otherwise, if <var title>c</var> is none of U+0009, U+000A, and
     U+000D, <span>potentially percent encode</span> <var title>c</var>
     using the <span>default encode set</span>, and append the result to
     <var title>buffer</var>.
    </ol>

   <dt><b title>query state</b>
   <dd>
    <ol>
     <li><p>If <var title>state override</var> is not given and <var title>c</var>
     is "<code title>#</code>", set
     <var title>url</var>'s <span title=concept-url-fragment>fragment</span> to the empty string,
     and state to <b title>fragment state</b>.

     <li>
      <p>Otherwise, if <var title>c</var> is none of
      <span>EOF code point</span>, U+0009, U+000A, and U+000D,
      <span>potentially percent encode</span> <var title>c</var> using the
      <span>query encode set</span> and
      <var title>encoding override</var>, and append the result to
      <var title>url</var>'s <span title=concept-url-query>query</span>.

      <p class=XXX>Only use <var title>encoding override</var> for
      http/https/file rather than for all relative schemes?
      <!-- http://simon.html5.org/test/url/url-encoding.html -->
    </ol>

   <dt><b title>fragment state</b>
   <dd><p>If <var title>c</var> is none of <span>EOF code point</span>,
   U+0009, U+000A, and U+000D, <span>potentially percent encode</span> <var title>c</var>
   using the <span>simple encode set</span>, and append the result to
   <var title>url</var>'s <span title=concept-url-fragment>fragment</span>.
   <!-- if people complain about this do not forget that results may differ
        depending on whether or not a relative scheme is in play -->
  </dl>

 <li><p>Return <var title>url</var>.
</ol>

<h3>Serializing</h3>

<p>The <dfn title=concept-url-serializer>URL serializer</dfn> takes a
<span title=concept-parsed-url>parsed URL</span> <var title>url</var>,
optionally an <i title>exclude fragment flag</i>, and then runs these steps:

<ol>
 <li><p>Let <var title>output</var> be <var title>url</var>'s
 <span title=concept-url-scheme>scheme</span> and
 "<code title>:</code>" concatenated.

 <li>
  <p>If <var title>url</var>'s <span>relative flag</span> is set:

  <ol>
   <li><p>Append "<code title>//</code>" to <var title>output</var>.

   <li>
    <p>If <var title>url</var>'s
    <span title=concept-url-username>username</span> is not the empty string
    or <var title>url</var>'s
    <span title=concept-url-password>password</span> is non-null, run these
    substeps:

    <ol>
     <li><p>Append <var title>url</var>'s
     <span title=concept-url-username>username</span> to
     <var title>output</var>.

     <li><p>If <var title>url</var>'s
     <span title=concept-url-password>password</span> is non-null, append
     "<code title>:</code>" concatenated with <var title>url</var>'s
     <span title=concept-url-password>password</span> to
     <var title>output</var>.

     <li><p>Append "<code title>@</code>" to <var title>output</var>.
    </ol>

   <li><p>Append <var title>url</var>'s
   <span title=concept-url-host>host</span>,
   <span title=concept-host-serializer>serialized</span>, to
   <var title>output</var>.

   <li><p>If <var title>url</var>'s <span title=concept-url-port>port</span>
   is not the empty string, append "<code title>:</code>" concatenated with
   <var title>url</var>'s <span title=concept-url-port>port</span> to
   <var title>output</var>.

   <li><p>Append "<code title>/</code>" concatenated with the strings in
   <var title>url</var>'s <span title=concept-url-path>path</span>
   (including empty strings), separated from each other by
   "<code title>/</code>" to <var title>output</var>.

   <li><p>If <var title>url</var>'s
   <span title=concept-url-query>query</span> is non-null, append
   "<code title>?</code>" concatenated with <var title>url</var>'s
   <span title=concept-url-query>query</span> to <var title>output</var>.
  </ol>

 <li><p>Otherwise, if <var title>url</var>'s <span>relative flag</span> is
 unset, append <var title>url</var>'s
 <span title=concept-url-scheme-data>scheme data</span> to
 <var title>output</var>.

 <li><p>If the <i title>exclude fragment flag</i> is unset and
 <var title>url</var>'s <span title=concept-url-fragment>fragment</span> is
 non-null, append  "<code title>#</code>" concatenated with
 <var title>url</var>'s <span title=concept-url-fragment>fragment</span> to
 <var title>output</var>.

 <li><p>Return <var title>output</var>.
</ol>



<h2>API</h2>

<!-- XXX http://lists.w3.org/Archives/Public/public-script-coord/2012OctDec/0082.html
     s/DOMString/UTFString -->

<pre class=idl>[<span title=dom-URL>Constructor</span>(DOMString <var title>url</var>, optional (<span>URL</span> or DOMString) <var title>base</var>)]
interface <dfn>URL</dfn> {
};
<span>URL</span> implements <span>URLUtils</span>;

[NoInterfaceObject]
interface <dfn>URLUtils</dfn> {
  stringifier attribute DOMString <span title=dom-URL-href>href</span>;
  readonly attribute DOMString <span title=dom-URL-origin>origin</span>;

           attribute DOMString <span title=dom-URL-protocol>protocol</span>;
           attribute DOMString <span title=dom-URL-username>username</span>;
           attribute DOMString <span title=dom-URL-password>password</span>;
           attribute DOMString <span title=dom-URL-host>host</span>;
           attribute DOMString <span title=dom-URL-hostname>hostname</span>;
           attribute DOMString <span title=dom-URL-port>port</span>;
           attribute DOMString <span title=dom-URL-pathname>pathname</span>;
           attribute DOMString <span title=dom-URL-search>search</span>;
  readonly attribute <span>URLQuery</span> <span title=dom-URL-query>query</span>;
           attribute DOMString <span title=dom-URL-hash>hash</span>;
};</pre>

<!-- Ideas:
           attribute DOMString basename; // last segment of path (Simon Sapin)
           sequence<DOMString> getPath();
           void setPath(DOMString segments...);

     Maybe also a way of comparing URLs? Or maybe rather a way to normalize
     a URL in a way that makes string comparison work better.

     Working with relative paths is another thing we could improve. E.g. a
     relPathname setter that would resolve the given value against pathname.

     Could make manipulation of host easier by exposing the labels similarly
     to the proposal for path segments above. (Should never expose
     effective TLD as it's evil.) -->

<p>Any object implementing <code>URLUtils</code> has an associated
<code>URLQuery</code> object,
<span title=concept-base-url>base URL</span> <b title>base</b>,
<b title>input</b>, <b title>query encoding</b>, and optionally a
<span title=concept-parsed-url>parsed URL</span> <b title>url</b>.
Unless stated otherwise, <b title>query encoding</b> is
<span data-anolis-spec=encoding>utf-8</span>. The others must be set on
creation by the specification using <code>URLUtils</code>.
<!-- standard > specification -->

<p class=note>The associated <b title>query encoding</b> is a legacy concept
only relevant for HTML. <span data-anolis-ref class=informative>HTML</span>


<h3>Constructors</h3> <!-- "constructor" causes dfn.js to fail -->

<p>The
<dfn title=dom-URL><code>URL(<var title>url</var>, <var title>base</var>)</code></dfn>
constructor must run these steps:

<ol>
 <li><p>If <var title>base</var> is not given, set it to
 "<code title>about:blank</code>".
 <!-- URLUtils needs an associated base URL -->

 <li><p>If <var title>base</var> is a string,
 <span title=concept-url-parser>parse</span> <var title>base</var> and set
 <var title>base</var> to the result of that algorithm.

 <li><p>If <var title>base</var> is failure,
 <span data-anolis-spec=dom title=concept-throw>throw</span> an
 "<code data-anolis-spec=dom>SyntaxError</code>" exception.

 <li><p>Let <var title>parsed URL</var> be the result of
 <span title=concept-url-parser>parsing</span> <var title>url</var>
 with <span title=concept-base-url>base URL</span> <var title>base</var>.

 <li><p>If <var title>parsed URL</var> is failure,
 <span data-anolis-spec=dom title=concept-throw>throw</span> an
 "<code data-anolis-spec=dom>SyntaxError</code>" exception.

 <li><p>Create a new <code>URL</code> object, set its <b title>url</b> to
 <var title>parsed URL</var>, <b title>base</b> to <var title>base</var>,
 and <b tilte>input</b> to <var title>url</var>, and then return the new
 object.
</ol>


<h3>Interface <code title>URLUtils</code></h3>

<p class=note>The <code>URLUtils</code> interface is not exposed on the
global object. It augments other interfaces, such as <code>URL</code>.

<p>The <dfn title=dom-URL-href><code>href</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the associated
 <b title>input</b>.

 <li><p>Return the <span title=concept-url-serializer>serialization</span>.
</ol>

<p>Setting the <code title=dom-URL-href>href</code> attribute must
run these steps:

<ol>
 <li><p>Unassociate <b title>url</b>.

 <li><p>Set the associated <b title>input</b> to the given value.

 <li><p>Let <var title>parsed URL</var> be the result of
 <span title=concept-url-parser>parsing</span> <b title>input</b>
 with <span title=concept-base-url>base URL</span> <b title>base</b> and
 <b title>query encoding</b> as <var title>encoding override</var>.

 <li><p>If <var title>parsed URL</var> is not failure, set <b title>url</b>
 to <var title>parsed URL</var>.
</ol>

<p>The <dfn title=dom-URL-origin><code>origin</code></dfn> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>Return the <span data-anolis-spec=origin>Unicode serialization</span>
 of the <b>url</b>'s <span data-anolis-spec=origin>origin</span>.
 <span data-anolis-ref>ORIGIN</span>
</ol>

<p class=note>It returns the Unicode rather than the ASCII serialization for
compatibility with HTML's <code>MessageEvent</code> feature.
<span data-anolis-ref class=informative>HTML</span>

<p>The <dfn title=dom-URL-protocol><code>protocol</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return
 "<code title>:</code>".

 <li><p>Return <span title=concept-url-scheme>scheme</span> and
 "<code title>:</code>" concatenated.
</ol>

<p>Setting the <code title=dom-URL-protocol>protocol</code> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, terminate these steps.

 <li><p><span title=concept-url-parser>Parse</span> the given value and
 "<code title>:</code>" concatenated with the associated <b title>url</b> as
 <var title>url</var> and <b title>scheme start state</b> as
 <var title>state override</var>.
</ol>

<p>The <dfn title=dom-URL-username><code>username</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>Return <span title=concept-url-username>username</span>.
</ol>

<p>Setting the <code title=dom-URL-username>username</code> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p>Set <span title=concept-url-username>username</span> to the empty
 string.

 <li><p>For each code point in the given value, <span>potentially percent encode</span> it
 using the <span>username encode set</span>, and append the result to
 <span title=concept-url-username>username</span>.
</ol>

<p>The <dfn title=dom-URL-password><code>password</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b> or its
 <span title=concept-url-password>password</span> is null, return the empty
 string.

 <li><p>Return <span title=concept-url-password>password</span>.
</ol>

<p>Setting the <code title=dom-URL-password>password</code> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p>If the given value is the empty string, set
 <span title=concept-url-password>password</span> to null, and terminate
 these steps.

 <li><p>Set <span title=concept-url-password>password</span> to the empty
 string.

 <li><p>For each code point in the given value, <span>potentially percent encode</span> it
 using the <span>password encode set</span>, and append the result to
 <span title=concept-url-password>password</span>.
</ol>

<p>The <dfn title=dom-URL-host><code>host</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>If <span title=concept-url-port>port</span> is the empty string,
 return <span title=concept-url-host>host</span>,
 <span title=concept-host-serializer>serialized</span>.

 <li><p>Return <span title=concept-url-host>host</span>,
 <span title=concept-host-serializer>serialized</span>,
 "<code title>:</code>", and <span title=concept-url-port>port</span>
 concatenated.
</ol>

<p>Setting the <code title=dom-URL-host>host</code> attribute must run these
steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p><span title=concept-url-parser>Parse</span> the given value with the
 associated <b title>url</b> as <var title>url</var>, and
 <b title>host state</b> as <var title>state override</var>.
</ol>

<p>The <dfn title=dom-URL-hostname><code>hostname</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>Return <span title=concept-url-host>host</span>,
 <span title=concept-host-serializer>serialized</span>.
</ol>

<p>Setting the <code title=dom-URL-hostname>hostname</code> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p><span title=concept-url-parser>Parse</span> the given value with the
 associated <b title>url</b> as <var title>url</var>, and
 <b title>hostname state</b> as <var title>state override</var>.
</ol>

<p>The <dfn title=dom-URL-port><code>port</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>Return <span title=concept-url-port>port</span>.
</ol>

<p>Setting the <code title=dom-URL-port>port</code> attribute must run these
steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, its
 <span>relative flag</span> is unset, or its
 <span title=concept-url-scheme>scheme</span> is "<code title>file</code>",
 terminate these steps.

 <li><p><span title=concept-url-parser>Parse</span> the given value with the
 associated <b title>url</b> as <var title>url</var>, and
 <b title>port state</b> as <var title>state override</var>.
</ol>

<p>The <dfn title=dom-URL-pathname><code>pathname</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, return the empty string.

 <li><p>If the <span>relative flag</span> is unset, return
 <span title=concept-url-scheme-data>scheme data</span>.

 <li><p>Return "<code title>/</code>" concatenated with the strings in
 <span title=concept-url-path>path</span> (including empty strings),
 separated from each other by "<code title>/</code>".
</ol>

<p>Setting the <code title=dom-URL-pathname>pathname</code> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p>Set <span title=concept-url-path>path</span> to the empty list.

 <li><p><span title=concept-url-parser>Parse</span> the given value with the
 associated <b title>url</b> as <var title>url</var>, and
 <b title>relative path start state</b> as <var title>state override</var>.
</ol>

<p>The <dfn title=dom-URL-search><code>search</code></dfn> attribute must
run these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span title=concept-url-query>query</span> is either null or
 the empty string, return the empty string.

 <li><p>Return "<code title>?</code>" concatenated with
 <span title=concept-url-query>query</span>.
</ol>

<p>Setting the <code title=dom-URL-search>search</code> attribute must run
these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span>relative flag</span> is unset, terminate these steps.

 <li><p>If the given value is the empty string, set
 <span title=concept-url-query>query</span> to null, and terminate these
 steps.

 <li><p>Let <var title>input</var> be the given value with a single leading
 "<code title>?</code>" removed, if any.

 <li><p>Set <span title=concept-url-query>query</span> to the empty string.

 <li><p><span title=concept-url-parser>Parse</span> <var title>input</var>
 with the associated <b title>url</b> as <var title>url</var>,
 <b title>query state</b> as <var title>state override</var>, and the
 associated <b title>query encoding</b> as <var title>encoding override</var>.
</ol>

<p>The <dfn title=dom-URL-query><code>query</code></dfn> attribute must
return the associated <code>URLQuery</code> object.

<p>The <dfn title=dom-URL-hash><code>hash</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span title=concept-url-fragment>fragment</span> is either null or
 the empty string, return the empty string.

 <li><p>Return "<code title>#</code>" concatenated with
 <span title=concept-url-fragment>fragment</span>.
</ol>

<p>Setting the <code title=dom-URL-hash>hash</code> attribute must run these
steps:

<ol>
 <li><p>If there is no associated <b title>url</b>, or its
 <span title=concept-url-scheme>scheme</span> is
 "<code title>javascript</code>", terminate these steps.

 <li><p>If the given value is the empty string, set
 <span title=concept-url-fragment>fragment</span> to null, and terminate
 these steps.

 <li><p>Let <var title>input</var> be the given value with a single leading
 "<code title>#</code>" removed, if any.

 <li><p>Set <span title=concept-url-fragment>fragment</span> to
 the empty string.

 <li><p><span title=concept-url-parser>Parse</span> <var title>input</var>
 with the associated <b title>url</b> as <var title>url</var>, and
 <b title>fragment state</b> as <var title>state override</var>.
</ol>


<h3>Interface <code title>URLQuery</code></h3>

<pre class=idl>interface <dfn>URLQuery</dfn> {
  DOMString? <span title=dom-URLQuery-get>get</span>(DOMString <var title>name</var>);
  sequence&lt;DOMString> <span title=dom-URLQuery-getAll>getAll</span>(DOMString <var title>name</var>);
  void <span title=dom-URLQuery-set>set</span>(DOMString name, (sequence&lt;DOMString> or DOMString) <var title>value</var>);
  void <span title=dom-URLQuery-delete>delete</span>(DOMString <var title>name</var>);
};</pre>

<p class=XXX>...



<h2 class=no-num>References</h2>
<div id=anolis-references></div>



<h2 class=no-num>Acknowledgments</h2>

<p>Thanks to
Adam Barth,
Alexandre Morgaut,
Boris Zbarsky,
David Sheets,
Erik Arvidsson,
Gavin Carothers,
Glenn Maynard,
Henri Sivonen,
Ian Hickson,
James Graham,
James Manger,
Martin Drst,
Mathias Bynens,
Michael Smith,
Rodney Rehm,
Simon Pieters,
Tab Atkins, and
Tantek elik
for being awesome!

<!-- http://dvcs.w3.org/hg/url/raw-file/feb258fa6ab5/Overview.html -->

<p>While this standard has been written from scratch, special thanks should
be extended to the editors of the various specifications that previously
defined what we now call URLs:
Larry Masinter,
Martin Drst,
Michel Suignard,
Roy Fielding, and
Tim Berners-Lee.

<!-- RFC 3986, RFC 3987 -->



<script id=head src=http://www.whatwg.org/specs/web-apps/current-work/dfn.js></script>
